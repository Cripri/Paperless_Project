<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신문고 등록</title>
  <link rel="stylesheet" th:href="@{/sinmungo/css/sinmungo_write.css}">
  <!-- 공통 헤더/푸터 -->
  <link rel="stylesheet" href="/header-footer/css/header-footer.css"
        th:href="@{/header-footer/css/header-footer.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="/header-footer/js/header-footer.js"
          th:src="@{/header-footer/js/header-footer.js}" defer></script>
</head>

<body class="site">
  <!-- header -->
  <div th:replace="fragments/header :: header"></div>
  <!-- /header -->

  <div class="container">
    <div class="help-top"><a href="#">상담민원 작성안내</a></div>
    <h1 class="page-title">상담민원 신청</h1>

    <form th:action="@{/sinmungo/write}" method="post" enctype="multipart/form-data">
      <div class="form-card">
        <table class="form-table">
          <tr>
            <th class="req">제목</th>
            <td colspan="3">
              <input type="text" class="input" name="title" placeholder="제목을 입력하세요" required>
            </td>
          </tr>

          <tr>
            <th class="req">휴대폰 번호</th>
            <td>
              <div class="row">
                <div class="col"><input type="text" class="input" name="telNum" placeholder="'-' 없이 숫자만" required></div>
              </div>
            </td>
            <th>전화번호</th>
            <td>
              <div class="row">
                <div class="col"><input type="text" class="input" name="telNum2" placeholder="'-' 없이 숫자만"></div>
              </div>
            </td>
          </tr>

          <tr>
            <th class="req">주소</th>
            <td colspan="3">
              <div class="row addr-row">
                <input type="text" class="input addr-input" name="postcode" placeholder="우편번호" required>
                <input type="text" class="input addr-input" name="addr1" placeholder="도로명/지번 주소" required>
                <input type="text" class="input addr-input" name="addr2" placeholder="상세 주소" required>
                <button type="button" class="btn addr-btn" disabled>주소검색</button>
              </div>
            </td>
          </tr>

          <tr>
            <th>별도 결과통지여부</th>
            <td colspan="3">
              <div class="options">
                <label><input type="checkbox" name="noticeBoard" checked disabled> 게시판 답변</label>

                <label>
                  <input type="hidden" name="noticeSms" value="N">
                  <input type="checkbox" name="noticeSms" value="Y"> 휴대전화 문자메시지(SMS)
                </label>

                <label>
                  <input type="checkbox" id="chkEmail"> 전자우편(E-MAIL)
                  <input type="email" class="input" name="noticeEmail" placeholder="email@example.com"
                    style="margin-left:8px;">
                </label>
              </div>
            </td>
          </tr>

          <tr>
            <th class="req">내용</th>
            <td colspan="3">
              <textarea class="textarea" name="content" placeholder="민원 내용을 상세히 입력해 주세요." required></textarea>
            </td>
          </tr>

          <tr>
            <th>첨부파일</th>
            <td colspan="3">
              <div class="hint">첨부파일 총 용량은 최대 6MByte입니다.</div>

              <div class="uploader" id="uploader">
                <div class="uploader-top">
                  <div class="dropzone" id="dropzone">
                    여기에 파일을 드래그하거나, <b>파일 추가</b> 버튼을 클릭하세요.
                  </div>
                  <button type="button" class="btn" id="btnAddFile">파일 추가</button>
                </div>

                <div class="uploader-meta">
                  <span>총 제한: <b>6 MB</b></span>
                  <span>현재 선택 용량: <b id="totalSize">0 MB</b></span>
                </div>

                <div class="file-items" id="fileItems"></div>

                <div id="hiddenInputs" style="display:none;"></div>
              </div>
            </td>
          </tr>

          <tr>
            <th>개인정보 동의</th>
            <td colspan="3">
              <label class="agree">
                <input type="checkbox" name="agree"> 개인정보 수집 및 이용*에 동의합니다.
                <a href="#"> 개인정보 수집 및 이용안내 자세히 보기</a>
              </label>
            </td>
          </tr>
        </table>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-cancel" onclick="history.back()">취소</button>
        <a class="btn" th:href="@{/sinmungo/list}">목록</a>
        <button type="button" class="btn btn-warn" disabled>임시저장</button>
        <button type="submit" class="btn btn-primary">등록</button>
      </div>
    </form>
  </div>

  <!-- footer -->
  <div th:replace="fragments/footer :: footer"></div>
  <!-- /footer -->

  <script>
    (function () {
      const MAX_TOTAL = 6 * 1024 * 1024;
      const fileItems = document.getElementById('fileItems');
      const dropzone = document.getElementById('dropzone');
      const btnAdd = document.getElementById('btnAddFile');
      const totalSizeEl = document.getElementById('totalSize');
      const hiddenBox = document.getElementById('hiddenInputs');

      function fmt(bytes) {
        if (bytes >= 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        if (bytes >= 1024) return (bytes / 1024).toFixed(0) + ' KB';
        return bytes + ' B';
      }

      function calcTotal() {
        let sum = 0;
        fileItems.querySelectorAll('input[type=file][name="files"]').forEach(inp => {
          if (inp.files && inp.files[0]) sum += inp.files[0].size || 0;
        });
        totalSizeEl.textContent = fmt(sum);
        return sum;
      }

      function appendLineWithInput(inp) {
        const f = inp.files && inp.files[0];
        if (!f) return;

        if (calcTotal() + (f.size || 0) > MAX_TOTAL) {
          alert('첨부파일 총 용량이 6MB를 초과합니다.');
          inp.remove();
          return;
        }

        const line = document.createElement('div');
        line.className = 'file-item';
        line.innerHTML = `
        <div class="file-name">
          <span class="badge">FILE</span>
          <span class="file-title" title="${f.name}">${f.name}</span>
          <span class="file-size">(${fmt(f.size || 0)})</span>
        </div>
        <button type="button" class="file-remove" title="삭제">삭제</button>
      `;

        inp.name = 'files';
        inp.hidden = true;
        line.appendChild(inp);

        line.querySelector('.file-remove').addEventListener('click', () => {
          line.remove();
          calcTotal();
        });

        fileItems.appendChild(line);
        calcTotal();
      }

      function createOneInputAndPick() {
        const input = document.createElement('input');
        input.type = 'file';
        hiddenBox.appendChild(input);

        input.addEventListener('change', function () {
          if (!this.files || !this.files[0]) {
            this.remove();
            return;
          }
          appendLineWithInput(this);
        }, { once: true });

        input.click();
      }

      // 버튼으로 추가
      btnAdd.addEventListener('click', () => {
        createOneInputAndPick();
      });

      // 드래그&드랍
      ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, e => {
          e.preventDefault(); e.stopPropagation();
          dropzone.classList.add('hover');
        });
      });
      ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => {
          e.preventDefault(); e.stopPropagation();
          dropzone.classList.remove('hover');
        });
      });
      dropzone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (!files || files.length === 0) return;

        Array.from(files).forEach(file => {
          const input = document.createElement('input');
          input.type = 'file';
          const dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
          hiddenBox.appendChild(input);
          appendLineWithInput(input);
        });
      });
    })();
  </script>

</body>

</html>