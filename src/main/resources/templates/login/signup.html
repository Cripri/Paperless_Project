<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link rel="stylesheet" href="/signup/css/signup.css">
</head>

<body>
    <div id="container">
        <h2>회원정보 입력</h2>
        <p><span class="redDot">*</span> 표시는 필수 항목입니다.</p>

        <form action="/signup" method="post" id="signupForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <table>
                <tr>
                    <th>이름 <span class="redDot">*</span></th>
                    <td><input type="text" name="userName" placeholder="홍길동"></td>
                </tr>
                <tr>
                    <th>생년월일 <span class="redDot">*</span></th>
                    <td><input type="text" name="userBirth" id="userBirth" maxlength="10" placeholder="YYYY-MM-DD"></td>
                    <!-- 에러 메시지 영역 -->
                    <span id="birthError" class="text-red-600" style="display:none"></span>
                </tr>
                <tr>
                    <th>아이디 <span class="redDot">*</span></th>
                    <td>
                        <input type="text" name="loginId">
                        <button type="button" class="btn btn-gray btn-sm" onclick="checkDup()">중복확인</button>
                    </td>
                </tr>
                <tr>
                    <th>비밀번호 <span class="redDot">*</span></th>
                    <td>
                        <input type="password" name="password">
                        <p style="font-size:12px; color:#555;">
                            * 영대문자, 영소문자, 숫자 및 특수문자 2종류 이상 포함시 10자리 이상 입력하십시오.<br>
                            <!-- * 영대문자, 영소문자, 숫자 및 특수문자 3종류 이상 포함시 최소 8자리 이상으로 입력하세요. -->
                        </p>
                    </td>
                </tr>
                <tr>
                    <th>비밀번호 확인 <span class="redDot">*</span></th>
                    <td><input type="password" name="passwordConfirm"></td>
                </tr>
                <tr>
                    <th>휴대폰번호 <span class="redDot">*</span></th>
                    <td>
                        010 -
                        <input type="text" name="phoneMid" size="4"> -
                        <input type="text" name="phoneLast" size="4">
                        <span style="font-size:12px; color:#777;">※ 분실된 회원정보 찾기 및 알림 등에 사용됩니다.</span>
                    </td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td>
                        <select name="telArea">
                            <option>선택</option>
                            <option>02</option>
                            <option>031</option>
                        </select> -
                        <input type="text" name="telMid" size="4"> -
                        <input type="text" name="telLast" size="4">
                    </td>
                </tr>
                <tr>
                    <th>이메일<span class="redDot">*</span></th>
                    <td>
                        <input type="text" name="emailId"> @
                        <input type="text" name="emailDomain" value="naver.com">
                        <select onchange="document.querySelector('[name=emailDomain]').value=this.value">
                            <option>naver.com</option>
                            <option>gmail.com</option>
                            <option>daum.net</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>주소 <span class="redDot">*</span></th>
                    <td>
                        <input type="text" id="postCode" name="postcode" placeholder="우편번호" readonly>
                        <button type="button" class="btn btn-gray btn-sm" onclick="execDaumPostcode()">우편번호
                            검색</button><br><br>
                        <input type="text" id="addr1" name="addr1" style="width:400px;" placeholder="기본주소"
                            readonly><br><br>
                        <input type="text" id="addr2" name="addr2" style="width:400px;" placeholder="상세주소">
                    </td>
                </tr>
            </table>
            
            <div class="btn-set">
                <!-- 가입 완료 후(서버에서 newUserId 세팅했을 때) -->
                <form method="post" action="/sns/connect/signup-complete" id="snsLinkCompleteForm">
                    <input type="hidden" name="newUserId" th:value="${newUserId}">
                    <button type="submit" class="btn btn-blue">SNS 연동 마치기</button>
                </form>
                <button type="submit" class="btn btn-blue">회원가입</button>
                <button type="reset" class="btn btn-gray">가입취소</button>
            </div>
        </form>
    </div>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    document.getElementById("postCode").value = data.zonecode; // 우편번호
                    document.getElementById("addr1").value = data.roadAddress; // 기본주소
                    document.getElementById("addr2").value = ""; // 상세주소는 직접 입력
                }
            }).open();
        }
    </script>
    <script>
        async function checkDup() {
            const loginId = document.querySelector('[name=loginId]').value;
            if (!loginId) return alert('아이디를 입력해주세요.');
            const res = await fetch(`/api/users/check-id?loginId=${encodeURIComponent(loginId)}`);
            const ok = await res.json();
            alert(ok.available ? '사용 가능한 아이디입니다.' : '이미 사용 중인 아이디입니다.');
        }
    </script>
    <script>
        (function () {
            const form = document.querySelector('#signupForm');        // ← 폼 id 지정
            const birthInput = document.getElementById('userBirth');
            const birthError = document.getElementById('birthError');

            // 입력 중 자동 하이픈 + 숫자만 허용 + 길이 제한
            birthInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/[^\d]/g, '').slice(0, 8); // YYYYMMDD 최대 8자리
                if (v.length >= 5) {
                    v = v.slice(0, 4) + '-' + v.slice(4, 6) + (v.length > 6 ? '-' + v.slice(6, 8) : '');
                }
                e.target.value = v;
            });

            // 폼 제출 시 유효성 검증
            form.addEventListener('submit', function (e) {
                const val = birthInput.value.trim();
                clearError();

                // 선택값: 공란이면 통과
                if (val === '') return;

                const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(val);
                if (!m) return fail(e, '생년월일은 YYYY-MM-DD 형식이어야 합니다.');

                const y = +m[1], mo = +m[2], d = +m[3];

                // 실제 달력 날짜인지(윤년 포함)
                const dt = new Date(y, mo - 1, d); // JS는 월 0~11
                const isSame =
                    dt.getFullYear() === y &&
                    dt.getMonth() === (mo - 1) &&
                    dt.getDate() === d;

                if (!isSame) return fail(e, '유효하지 않은 날짜입니다.');

                // 미래 금지, 연도 하한(필요 시 조정)
                const today = new Date(); today.setHours(0, 0, 0, 0);
                if (dt > today) return fail(e, '미래 날짜는 입력할 수 없습니다.');
                if (y < 1900) return fail(e, '연도는 1900년 이후만 허용합니다.');

                // 나이 제한(필요 시 사용; 주석 해제)
                // const age = calcAge(dt, today);
                // if (age < 14 || age > 120) return fail(e, '만 14세 이상, 120세 이하만 가입할 수 있습니다.');

                // 통과 시 에러표시 숨김
                clearError();
            });

            function fail(e, msg) {
                e.preventDefault();
                birthError.textContent = msg;
                birthError.style.display = 'inline';
                alert(msg);
                birthInput.focus();
            }

            function clearError() {
                birthError.textContent = '';
                birthError.style.display = 'none';
            }

            function calcAge(birthDate, baseDate) {
                let age = baseDate.getFullYear() - birthDate.getFullYear();
                const m = baseDate.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && baseDate.getDate() < birthDate.getDate())) age--;
                return age;
            }
        })();

        (function () {
            const p = new URLSearchParams(location.search);
            if (p.get('linkedSns') === '1') {
                alert('회원가입과 SNS 연동이 완료되었습니다. 이제 소셜 로그인 버튼으로 바로 로그인할 수 있습니다.');
            } else if (p.get('joined') === '1') {
                alert('회원가입이 완료되었습니다. 로그인해 주세요.');
            }
        })();
    </script>
</body>

</html>