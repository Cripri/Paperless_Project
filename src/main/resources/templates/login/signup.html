<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link rel="stylesheet" href="/signup/css/signup.css">
</head>

<body>
    <div id="container">
        <h2>회원정보 입력</h2>
        <p><span class="redDot">*</span> 표시는 필수 항목입니다.</p>

        <form action="/signup" method="post" id="signupForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <table>
                <tr>
                    <th>이름 <span class="redDot">*</span></th>
                    <td><input type="text" name="userName" placeholder="홍길동"></td>
                </tr>
                <tr>
                    <th>생년월일 <span class="redDot">*</span></th>
                    <td><input type="text" name="userBirth" id="userBirth" maxlength="10" placeholder="YYYY-MM-DD"></td>
                    <!-- 에러 메시지 영역 -->
                    <span id="birthError" class="text-red-600" style="display:none"></span>
                </tr>
                <tr>
                    <th>아이디 <span class="redDot">*</span></th>
                    <td>
                        <input type="text" name="loginId">
                        <button type="button" class="btn btn-gray btn-sm" onclick="checkDup()">중복확인</button>
                    </td>
                </tr>
                <tr>
                    <th>비밀번호 <span class="redDot">*</span></th>
                    <td>
                        <input type="password" name="password">
                        <p style="font-size:12px; color:#555;">
                            * 영대문자, 영소문자, 숫자 및 특수문자 2종류 이상 포함시 8자리 이상 입력하십시오.<br>
                        </p>
                    </td>
                </tr>
                <tr>
                    <th>비밀번호 확인 <span class="redDot">*</span></th>
                    <td><input type="password" name="passwordConfirm"></td>
                </tr>
                <tr>
                    <th>휴대폰번호 <span class="redDot">*</span></th>
                    <td>
                        010 -
                        <input type="text" name="phoneMid" size="4"> -
                        <input type="text" name="phoneLast" size="4">
                        <span style="font-size:12px; color:#777;">※ 분실된 회원정보 찾기 및 알림 등에 사용됩니다.</span>
                    </td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td>
                        <select name="telArea">
                            <option>선택</option>
                            <option>02</option>
                            <option>031</option>
                        </select> -
                        <input type="text" name="telMid" size="4"> -
                        <input type="text" name="telLast" size="4">
                    </td>
                </tr>
                <tr>
                    <th>이메일<span class="redDot">*</span></th>
                    <td>
                        <input type="text" name="emailId"> @
                        <input type="text" name="emailDomain" value="naver.com">
                        <select onchange="document.querySelector('[name=emailDomain]').value=this.value">
                            <option>naver.com</option>
                            <option>gmail.com</option>
                            <option>daum.net</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>주소 <span class="redDot">*</span></th>
                    <td>
                        <input type="text" id="postCode" name="postcode" placeholder="우편번호" readonly>
                        <button type="button" class="btn btn-gray btn-sm" onclick="execDaumPostcode()">우편번호
                            검색</button><br><br>
                        <input type="text" id="addr1" name="addr1" style="width:400px;" placeholder="기본주소"
                            readonly><br><br>
                        <input type="text" id="addr2" name="addr2" style="width:400px;" placeholder="상세주소">
                    </td>
                </tr>
            </table>

            <div class="btn-set">
                <button type="submit" class="btn btn-blue">회원가입</button>
                <button type="reset" class="btn btn-gray" onclick="location.href='/login'">가입취소</button>
            </div>
        </form>
    </div>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    document.getElementById("postCode").value = data.zonecode; // 우편번호
                    document.getElementById("addr1").value = data.roadAddress; // 기본주소
                    document.getElementById("addr2").value = ""; // 상세주소는 직접 입력
                }
            }).open();
        }
    </script>
    <script>
        async function checkDup() {
            const loginId = document.querySelector('[name=loginId]').value;
            if (!loginId) return alert('아이디를 입력해주세요.');
            const res = await fetch(`/api/users/check-id?loginId=${encodeURIComponent(loginId)}`);
            const ok = await res.json();
            alert(ok.available ? '사용 가능한 아이디입니다.' : '이미 사용 중인 아이디입니다.');
        }
    </script>
    <script>
        (function () {
            const form = document.querySelector('#signupForm');
            const birthInput = document.getElementById('userBirth');
            const birthError = document.getElementById('birthError');

            birthInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/[^\d]/g, '').slice(0, 8); // YYYYMMDD 최대 8자리
                if (v.length >= 5) {
                    v = v.slice(0, 4) + '-' + v.slice(4, 6) + (v.length > 6 ? '-' + v.slice(6, 8) : '');
                }
                e.target.value = v;
            });

            // 폼 제출 시 유효성 검증
            form.addEventListener('submit', function (e) {
                const val = birthInput.value.trim();
                clearError();

                if (val === '') return;

                const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(val);
                if (!m) return fail(e, '생년월일은 YYYY-MM-DD 형식이어야 합니다.');

                const y = +m[1], mo = +m[2], d = +m[3];

                const dt = new Date(y, mo - 1, d);
                const isSame =
                    dt.getFullYear() === y &&
                    dt.getMonth() === (mo - 1) &&
                    dt.getDate() === d;

                if (!isSame) return fail(e, '유효하지 않은 날짜입니다.');

                const today = new Date(); today.setHours(0, 0, 0, 0);
                if (dt > today) return fail(e, '미래 날짜는 입력할 수 없습니다.');
                if (y < 1900) return fail(e, '연도는 1900년 이후만 허용합니다.');

                // 통과 시 에러표시 숨김
                clearError();
            });

            function fail(e, msg) {
                e.preventDefault();
                birthError.textContent = msg;
                birthError.style.display = 'inline';
                alert(msg);
                birthInput.focus();
            }

            function clearError() {
                birthError.textContent = '';
                birthError.style.display = 'none';
            }

            function calcAge(birthDate, baseDate) {
                let age = baseDate.getFullYear() - birthDate.getFullYear();
                const m = baseDate.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && baseDate.getDate() < birthDate.getDate())) age--;
                return age;
            }
        })();

        (function () {
            const p = new URLSearchParams(location.search);
            if (p.get('linkedSns') === '1') {
                alert('회원가입과 SNS 연동이 완료되었습니다. 이제 소셜 로그인 버튼으로 바로 로그인할 수 있습니다.');
            } else if (p.get('joined') === '1') {
                alert('회원가입이 완료되었습니다. 로그인해 주세요.');
            }
        })();

        (function () {
            const MIN_LEN = 8;
            const NEED_CAT = 2;

            const form = document.getElementById('signupForm');
            const pw = form.querySelector('input[name="password"]');
            const pwCfm = form.querySelector('input[name="passwordConfirm"]');
            const submitBtn = form.querySelector('button[type="submit"]');

            // 메시지 영역 동적 생성
            const msgPw = document.createElement('div');
            const msgCfm = document.createElement('div');
            msgPw.id = 'pwPolicyMsg';
            msgCfm.id = 'pwConfirmMsg';
            msgPw.style.cssText = 'margin-top:6px;font-size:12px;';
            msgCfm.style.cssText = 'margin-top:6px;font-size:12px;';
            if (!pw.nextElementSibling || pw.nextElementSibling.id !== 'pwPolicyMsg') {
                pw.insertAdjacentElement('afterend', msgPw);
            }
            if (!pwCfm.nextElementSibling || pwCfm.nextElementSibling.id !== 'pwConfirmMsg') {
                pwCfm.insertAdjacentElement('afterend', msgCfm);
            }

            function categoriesCount(s) {
                let c = 0;
                if (/[A-Z]/.test(s)) c++;
                if (/[a-z]/.test(s)) c++;
                if (/\d/.test(s)) c++;
                if (/[^A-Za-z0-9]/.test(s)) c++;
                return c;
            }

            function unmetRequirements(s) {
                const unmet = [];
                if (s.length < MIN_LEN) unmet.push(`길이 ${MIN_LEN}자 이상`);
                if (categoriesCount(s) < NEED_CAT) unmet.push('영대/영소/숫자/특수문자 중 2종 이상');
                return unmet;
            }

            function strengthLabel(s) {
                const len = s.length;
                const cat = categoriesCount(s);
                if (len >= 12 && cat >= 3) return '강함';
                if (len >= 10 && cat >= 2) return '보통';
                return '약함';
            }

            function validateNew() {
                const v = pw.value;
                if (!v) {
                    msgPw.textContent = '';
                    pw.classList.remove('is-valid', 'is-invalid');
                    return false;
                }
                const unmet = unmetRequirements(v);
                if (unmet.length) {
                    msgPw.innerHTML = '❌ 비밀번호 조건 미충족: ' + unmet.join(' · ');
                    msgPw.style.color = '#d00';
                    pw.classList.add('is-invalid'); pw.classList.remove('is-valid');
                    return false;
                } else {
                    msgPw.innerHTML = '✅ 사용 가능한 비밀번호 · 강도: <b>' + strengthLabel(v) + '</b>';
                    msgPw.style.color = '#067';
                    pw.classList.add('is-valid'); pw.classList.remove('is-invalid');
                    return true;
                }
            }

            function validateMatch() {
                const a = pw.value, b = pwCfm.value;
                if (!b) {
                    msgCfm.textContent = '';
                    pwCfm.classList.remove('is-valid', 'is-invalid');
                    return false;
                }
                if (a === b) {
                    msgCfm.textContent = '✅ 비밀번호가 일치합니다.'; msgCfm.style.color = '#067';
                    pwCfm.classList.add('is-valid'); pwCfm.classList.remove('is-invalid');
                    return true;
                } else {
                    msgCfm.textContent = '❌ 비밀번호가 일치하지 않습니다.'; msgCfm.style.color = '#d00';
                    pwCfm.classList.add('is-invalid'); pwCfm.classList.remove('is-valid');
                    return false;
                }
            }

            function toggleSubmit() {
                const entered = pw.value.length + pwCfm.value.length > 0;
                const ok = validateNew() && validateMatch();
                submitBtn.disabled = entered ? !ok : false;
            }

            pw.addEventListener('input', () => { validateNew(); validateMatch(); toggleSubmit(); });
            pwCfm.addEventListener('input', () => { validateMatch(); toggleSubmit(); });


            form.addEventListener('submit', (e) => {
                const ok = validateNew() && validateMatch();
                if (!ok) {
                    e.preventDefault();
                    alert('비밀번호 정책을 확인해 주세요: 길이 8자 이상, 대/소/숫자/특수 중 2종 이상 포함, 그리고 확인과 일치해야 합니다.');
                }
            });
        })();
    </script>
</body>

</html>