<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이페이지</title>
  <link rel="stylesheet" href="/mypage/css/mypage_sinmungo.css" th:href="@{/mypage/css/mypage_sinmungo.css}">
  <link rel="stylesheet" href="/header-footer/css/header-footer.css" th:href="@{/header-footer/css/header-footer.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="/header-footer/js/header-footer.js" th:src="@{/header-footer/js/header-footer.js}" defer></script>
</head>

<body>
  <!-- header -->
  <div th:replace="~{fragments/header :: header}"></div>
  <!-- header -->

  <div id="container">
    <article id="content">
      <div class="content-header">
        <h2 class="content-title">내 민원</h2>
      </div>

      <div class="content-body" id="printArea">
        <form class="bbs-search" id="dataForm" name="dataForm" th:action="@{/mypage_sinmungo}" method="get">
          <input type="hidden" name="q_cvplSn" id="q_cvplSn" value="">
          <input type="hidden" id="q_cvplCtgryCode" name="q_cvplCtgryCode" value="">

          <fieldset>
            <div class="input-area select-length2">
              <select class="form-control" title="검색분류" id="q_searchTy" name="q_searchTy" th:value="${q_searchTy}">
                <option value="1001" th:selected="${q_searchTy}=='1001'">제목</option>
                <option value="1002" th:selected="${q_searchTy}=='1002'">내용</option>
                <option value="all" th:selected="${q_searchTy}=='all'">제목+내용</option>
              </select>
              <input type="text" id="q_searchVal" name="q_searchVal" class="form-control form-control-keyword"
                title="검색어" th:value="${q_searchVal}">
            </div>

            <div class="btn-area">
              <span class="col"><button type="submit" class="btn btn-lg btn-primary">검색</button></span>
              <span class="col"><a class="btn btn-lg btn-outline-light" th:href="@{/mypage_sinmungo}">초기화</a></span>
            </div>
          </fieldset>
          <input type="hidden" name="q_rowPerPage" id="q_rowPerPage" th:value="${q_rowPerPage}">
          <input type="hidden" name="q_currPage" id="q_currPage" th:value="${q_currPage}">
        </form>

        <div class="list-info">
          <div class="float-left">
            <p class="total">
              총 <strong th:text="${#numbers.formatInteger(totalCount, 0, 'COMMA')}">0</strong>
              건 (<span th:text="${page.number + 1}">1</span>/<span
                th:text="${page.totalPages == 0 ? 1 : page.totalPages}">1</span> page)
            </p>
          </div>
        </div>

        <table class="table table-list" style="table-layout: fixed">
          <colgroup>
            <col style="width: 7%">
            <col style="width: 15%;">
            <col>
            <col style="width: 10%;">
            <col style="width: 13%;">
            <col style="width: 10%;">
          </colgroup>
          <thead>
            <tr>
              <th scope="col">번호</th>
              <th scope="col">구분</th>
              <th scope="col">민원제목</th>
              <th scope="col">진행상황</th>
              <th scope="col">등록일</th>
              <th scope="col">담당자</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="item, stat : ${items}">
              <td th:text="${page.totalElements - (page.number * page.size) - stat.index}">1</td>
              <td>민원</td>
              <td>
                <a th:href="@{/sinmungo/detail/{id}(
                      id=${item.smgId},
                      page=${q_currPage},
                      size=${q_rowPerPage},
                      keyword=${q_searchVal},
                      status=${status},
                      searchType=${q_searchTy}
                    )}" th:text="${item.title}" class="link-underline">
                  민원제목
                </a>
                <span th:if="${item.status == '반려' || item.status?.toUpperCase() == 'REJECTED'}" class="badge"
                  style="margin-left:6px;background:#ef4444;color:#fff;padding:2px 6px;border-radius:4px;">
                  반려
                </span>
              </td>
              <td th:text="${item.status}">상태</td>
              <td th:text="${#temporals.format(item.createdAt, 'yyyy-MM-dd')}">-</td>
              <td th:text="${adminNamesMasked[item.smgId]}">담당자</td>
            </tr>
            <tr th:if="${#lists.isEmpty(items)}">
              <td colspan="6" class="nodata">게시물이 없습니다.</td>
            </tr>
          </tbody>
        </table>

        <nav class="pager" aria-label="페이지 이동" th:attr="data-total-pages=${page.totalPages == 0 ? 1 : page.totalPages}">
          <button id="prev" class="btn" type="button" aria-label="이전 페이지" th:disabled="${page.first}">이전</button>
          <span id="page-info" class="page-info" aria-live="polite"
            th:text="${page.number + 1} + ' / ' + ${(page.totalPages == 0 ? 1 : page.totalPages)}">1 / 1</span>
          <button id="next" class="btn" type="button" aria-label="다음 페이지" th:disabled="${page.last}">다음</button>
        </nav>
      </div>
    </article>
  </div>

  <!-- footer -->
  <div th:replace="~{fragments/footer :: footer}"></div>
  <!-- footer -->

  <script>
    (function () {
      const form = document.getElementById('dataForm');
      const curr = document.getElementById('q_currPage');
      const pager = document.querySelector('nav.pager');
      const totalPages = parseInt(pager.dataset.totalPages || '1', 10);

      document.getElementById('prev').addEventListener('click', function () {
        let p = parseInt(curr.value || '1', 10);
        if (p > 1) { curr.value = String(p - 1); form.submit(); }
      });
      document.getElementById('next').addEventListener('click', function () {
        let p = parseInt(curr.value || '1', 10);
        if (p < totalPages) { curr.value = String(p + 1); form.submit(); }
      });
    })();
  </script>
</body>

</html>